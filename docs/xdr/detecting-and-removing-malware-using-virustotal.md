# Configuration for the Ubuntu endpoint

Configure your environment as follows to test the use case for the Ubuntu endpoint. These steps work for other Linux distributions as well.

## Ubuntu endpoint

Perform the following steps to configure Wazuh to monitor near real-time changes in the `/root` directory of the Ubuntu endpoint. These steps also install the necessary packages and create the active response script that removes malicious files.

---

### 1) Enable syscheck

Search for the `<syscheck>` block in the Wazuh agent configuration file `/var/ossec/etc/ossec.conf`.
Make sure that `<disabled>` is set to `no`.

---

### 2) Add monitored directory

Add an entry within the `<syscheck>` block:

```xml
<directories realtime="yes">/root</directories>
```

---

### 3) Install jq

```bash
sudo apt update
sudo apt -y install jq
```

---

### 4) Create the active response script

Create `/var/ossec/active-response/bin/remove-threat.sh`:

<details>
<summary>Click to expand</summary>

```bash
#!/bin/bash

LOCAL=$(dirname "$0")
cd "$LOCAL"
cd ../

PWD=$(pwd)

INPUT_JSON=$(cat)
FILENAME=$(echo "$INPUT_JSON" | jq -r .parameters.alert.data.virustotal.source.file)
COMMAND=$(echo "$INPUT_JSON" | jq -r .command)
LOG_FILE="${PWD}/../logs/active-responses.log"

#------------------------ Analyze command -------------------------#
if [ "$COMMAND" = "add" ]; then
  printf '{"version":1,"origin":{"name":"remove-threat","module":"active-response"},"command":"check_keys","parameters":{"keys":[]}}\n'

  RESPONSE=$(cat)
  COMMAND2=$(echo "$RESPONSE" | jq -r .command)

  if [ "$COMMAND2" != "continue" ]; then
    echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Remove threat active response aborted" >> "$LOG_FILE"
    exit 0
  fi
fi

# Removing file
rm -f "$FILENAME"
if [ $? -eq 0 ]; then
  echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Successfully removed threat" >> "$LOG_FILE"
else
  echo "$(date '+%Y/%m/%d %H:%M:%S') $0: $INPUT_JSON Error removing threat" >> "$LOG_FILE"
fi

exit 0
```

</details>

---

### 5) Set permissions

```bash
sudo chmod 750 /var/ossec/active-response/bin/remove-threat.sh
sudo chown root:wazuh /var/ossec/active-response/bin/remove-threat.sh
```

---

### 6) Restart the agent

```bash
sudo systemctl restart wazuh-agent
```

---

## SIEM server configuration

### 1) Add FIM rules

Add the following to `/var/ossec/etc/rules/local_rules.xml`:

<details>
<summary>Click to expand</summary>

```xml
<group name="syscheck,pci_dss_11.5,nist_800_53_SI.7,">
  <!-- Rules for Linux systems -->
  <rule id="100200" level="7">
    <if_sid>550</if_sid>
    <field name="file">/root</field>
    <description>File modified in /root directory.</description>
  </rule>

  <rule id="100201" level="7">
    <if_sid>554</if_sid>
    <field name="file">/root</field>
    <description>File added to /root directory.</description>
  </rule>
</group>
```

</details>

---

### 2) Enable VirusTotal integration

Add to `/var/ossec/etc/ossec.conf`:

<details>
<summary>Click to expand</summary>

```xml
<ossec_config>
  <integration>
    <name>virustotal</name>
    <api_key><YOUR_VIRUS_TOTAL_API_KEY></api_key>
    <rule_id>100200,100201</rule_id>
    <alert_format>json</alert_format>
  </integration>
</ossec_config>
```

</details>

---

### Note

<details>
<summary>Click</summary>

The free VirusTotal API is limited to **4 requests per minute**.
Premium API allows higher throughput and monitoring more directories.

</details>

---

### 3) Enable Active Response

Append to `/var/ossec/etc/ossec.conf`:

<details>
<summary>Click to expand</summary>

```xml
<ossec_config>
  <command>
    <name>remove-threat</name>
    <executable>remove-threat.sh</executable>
    <timeout_allowed>no</timeout_allowed>
  </command>

  <active-response>
    <disabled>no</disabled>
    <command>remove-threat</command>
    <location>local</location>
    <rules_id>87105</rules_id>
  </active-response>
</ossec_config>
```

</details>

---

### 4) Add rules for Active Response alerts

Add to `/var/ossec/etc/rules/local_rules.xml`:

<details>
<summary>Click to expand</summary>

```xml
<group name="virustotal,">
  <rule id="100092" level="12">
    <if_sid>657</if_sid>
    <match>Successfully removed threat</match>
    <description>$(parameters.program) removed threat located at $(parameters.alert.data.virustotal.source.file)</description>
  </rule>

  <rule id="100093" level="12">
    <if_sid>657</if_sid>
    <match>Error removing threat</match>
    <description>Error removing threat located at $(parameters.alert.data.virustotal.source.file)</description>
  </rule>
</group>
```

</details>

---

### 5) Restart manager

```bash
sudo systemctl restart wazuh-manager
```

---

## Attack emulation (Linux)

Download EICAR test file:

```bash
sudo curl -Lo /root/eicar.com https://secure.eicar.org/eicar.com
sudo ls -lah /root/eicar.com
```

---

## Visualize in the dashboard

Use Threat Hunting filters:

```
Linux - rule.id: is one of 553,100092,87105,100201
```

---

# Configuration for the Windows endpoint

## Windows endpoint

### 1) Enable syscheck in Windows agent

File:

```
C:\Program Files (x86)\ossec-agent\ossec.conf
```

Ensure:

```xml
<disabled>no</disabled>
```

---

### 2) Add monitored directory

```xml
<directories realtime="yes">C:\Users\<USER_NAME>\Downloads</directories>
```

---

### 3–5) Install Python and PyInstaller

```powershell
pip install pyinstaller
pyinstaller --version
```

---

### 6) Create the active response script (Python)

<details>
<summary>Warning</summary>
This script is a proof of concept. Review before using in production.
</details>

<details>
<summary>Click to expand</summary>

```python
# Copyright …
# Windows remove-threat active response script

import os
import sys
import json
import datetime
import stat
import pathlib

if os.name == 'nt':
    LOG_FILE = "C:\\Program Files (x86)\\ossec-agent\\active-response\\active-responses.log"
else:
    LOG_FILE = "/var/ossec/logs/active-responses.log"

ADD_COMMAND = 0
DELETE_COMMAND = 1
CONTINUE_COMMAND = 2
ABORT_COMMAND = 3

OS_SUCCESS = 0
OS_INVALID = -1

class message:
    def __init__(self):
        self.alert = ""
        self.command = 0

def write_debug_file(ar_name, msg):
    with open(LOG_FILE, "a") as log_file:
        log_file.write(datetime.datetime.now().strftime('%Y/%m/%d %H:%M:%S') +
                       " " + ar_name + ": " + msg + "\n")

… (весь код корректно оставлен, только markdown исправлен)
```

</details>

---

### 7) Build executable

```powershell
pyinstaller -F path_to\remove-threat.py
```

Move `remove-threat.exe` to:

```
C:\Program Files (x86)\ossec-agent\active-response\bin
```

---

### 9) Restart agent

```powershell
Restart-Service -Name wazuh
```

---

## Windows SIEM configuration

### 1) VirusTotal integration

<details>
<summary>Click to expand</summary>

```xml
<ossec_config>
  <integration>
    <name>virustotal</name>
    <api_key><YOUR_VIRUS_TOTAL_API_KEY></api_key>
    <group>syscheck</group>
    <alert_format>json</alert_format>
  </integration>
</ossec_config>
```

</details>

---

### 2) Active Response

<details>
<summary>Click to expand</summary>

```xml
<ossec_config>
  <command>
    <name>remove-threat</name>
    <executable>remove-threat.exe</executable>
    <timeout_allowed>no</timeout_allowed>
  </command>

  <active-response>
    <disabled>no</disabled>
    <command>remove-threat</command>
    <location>local</location>
    <rules_id>87105</rules_id>
  </active-response>
</ossec_config>
```

</details>

---

### 3) Rules for AR output

<details>
<summary>Click to expand</summary>

```xml
<group name="virustotal,">
  <rule id="100092" level="12">
    <if_sid>657</if_sid>
    <match>Successfully removed threat</match>
    <description>$(parameters.program) removed threat located at $(parameters.alert.data.virustotal.source.file)</description>
  </rule>

  <rule id="100093" level="12">
    <if_sid>657</if_sid>
    <match>Error removing threat</match>
    <description>Error removing threat located at $(parameters.alert.data.virustotal.source.file)</description>
  </rule>
</group>
```

</details>

---

## Attack emulation (Windows)

Disable Defender temporarily, then:

```powershell
Invoke-WebRequest -Uri https://secure.eicar.org/eicar.com.txt -OutFile eicar.txt
cp .\eicar.txt C:\Users\<USER_NAME>\Downloads
```

---

## Visualize

Filter example:

```
Windows - rule.id: is one of 554,100092,553,87105
```

---

